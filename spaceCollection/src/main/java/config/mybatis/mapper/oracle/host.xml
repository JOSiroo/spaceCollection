<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sc.spaceCollection.host.model.HostDAO">
	<!-- 카테고리가 메인이고 resultmap에는 메인에 대한걸 작성 
	컬렉션은 select category에서 가져온 categoryno로 type을 조회한다. -->
	
	<select id="selectSpaceType" resultType="SpaceTypeVO" parameterType="int">
		select * from space_type
		where category_no = #{categoryNo}
		and SPACE_TYPE_DEL_FLAG is null
	</select>
	
	<resultMap type="SpaceCategoryAllVO" id="spaceTypeResultMap">
		<association property="spaceCategoryVo" column="categoryNo" javaType="SpaceCategoryVO" >
			<id property="categoryNo" column="category_no" jdbcType="BIGINT" />
			<result property="categoryName" column="category_name" jdbcType="VARCHAR" />
		</association>
		<collection property="spaceTypeList" javaType="ArrayList" ofType="map" 
			column="category_no" select="selectSpaceType">
		</collection>
	</resultMap>

	<select id="selectSpaceCategory" resultMap="spaceTypeResultMap">
		select * from space_type_category
		where CATEGORY_DEL_FLAG is null
		order by category_no
	</select>
	
	<select id="selectUserById" resultType="userInfoVo" parameterType="String">
		select * from user_info
		where user_id = #{userId}
	</select>
	
	<insert id="insertSpace" parameterType="spaceVo">
		<selectKey keyProperty="spaceNum" order="BEFORE" resultType="int">
			select space_seq.nextval from dual
		</selectKey>
		insert into space(space_num, space_name, space_business_num, space_zipcode, space_address, 
		    space_address_detail, space_location, space_intro, space_info, space_tag, space_facility, 
		    space_phone_num, space_warn, latitude, longitude, refund_num, user_num, space_type_no,space_request_status)
		values (#{spaceNum}, #{spaceName}, #{spaceBusinessNum}, #{spaceZipcode}, #{spaceAddress},
				#{spaceAddressDetail}, #{spaceLocation}, #{spaceIntro}, #{spaceInfo}, #{spaceTag}, 
				#{spaceFacility}, #{spacePhoneNum}, #{spaceWarn}, #{latitude}, #{longitude}, 
				#{refundNum}, #{userNum}, #{spaceTypeNo}, 'R')
	</insert>
	
	<select id="selectSpaceTypeBySpaceTypeName" resultType="spaceTypeVo" parameterType="String">
		select * from space_type
		where space_type_name = #{spaceTypeName}
	</select>
	
	<insert id="insertRefund" parameterType="refundVo">
		<selectKey keyProperty="refundNum" order="BEFORE" resultType="int">
			select refund_seq.nextval from dual
		</selectKey>
		insert into refund
		values (#{refundNum}, #{refund7Day}, #{refund6Day}, #{refund5Day}, #{refund4Day}, 
				#{refund3Day}, #{refund2Day}, #{refund1Day}, #{refundDay})
	</insert>
	
	<insert id="insertSpaceTotalFacility" parameterType="spaceTotalFacilityVo">
		<selectKey keyProperty="spaceFacilityNum" order="BEFORE" resultType="int">
			select space_total_facility_seq.nextval from dual
		</selectKey>
		insert into space_total_facility(SPACE_FACILITY_NUM, FAC_WIFI, FAC_PRINTER, FAC_CHAIR_TABLE,
										FAC_SMOKE, FAC_REST_ROOM, FAC_PC, FAC_TV, FAC_WHITE_BOARD, FAC_ELEVATOR, 
										FAC_PARKING, FAC_FOOD, FAC_DRINK, FAC_COOK, FAC_PET, FAC_AUDIO, SPACE_NUM)
    
		values (#{spaceFacilityNum}, #{facWifi}, #{facPrinter}, #{facChairTable}, #{facSmoke}, #{facRestRoom},
				 #{facPC}, #{facTV}, #{facWhiteBoard}, #{facElevator}, #{facParking},
				 #{facFood}, #{facDrink}, #{facCook}, #{facPet}, #{facAudio}, #{spaceNum})
	</insert>
	
	<insert id="insertFacility" parameterType="facilityVo">
		<selectKey keyProperty="facilityNum" order="BEFORE" resultType="int">
			select facility_seq.nextval from dual
		</selectKey>
		insert into facility
		values (#{facilityNum}, #{facWifi}, #{facPrinter}, #{facChairTable}, #{facSmoke}, 
				#{facRestRoom}, #{facPC}, #{facTV}, #{facWhiteBoard}, #{facElevator}, #{facParking}, 
				#{facFloor}, #{facFood}, #{facDrink}, #{facCook}, #{facPet}, #{facAudio})
	</insert>
	
	<insert id="insertSpaceDetail" parameterType="spaceDetailVo">
		<selectKey keyProperty="sdNum" order="BEFORE" resultType="int">
			select space_detail_seq.nextval from dual
		</selectKey>
		insert into space_detail()
		values ()
	</insert>
	
	<select id="selectHostReservation" resultType="map">
		select *
		from
		(
		    select rownum as rn, f.* 
		    from 
		    (
		        select * from host_reservation_view
		        where user_num = #{userNum}
		        <if test='status != null and status != ""'>
		        		and
		        	<if test="status == 'before'"><![CDATA[RESERVE_START_DAY >= sysdate ]]></if>
		        	<if test="status == 'finished'"><![CDATA[RESERVE_START_DAY <= sysdate ]]></if>
		        	<if test="status == 'canceled'">RESERVATION_DEL_FLAG = 'Y'</if>
		        </if>
		        <if test='keyword != "" and keyword != null'>
					and USER_ID like '%' || #{keyword} || '%'
		        </if>
		        <if test='order != null and order != ""'>
					order by ${order} asc       
		        </if>
		    )f
		)A
		<![CDATA[ 
		where rn >= #{startRow} and rn <= #{endRow} ]]>
	</select>
	<select id="HostReservationCalendar" resultType="map">
        select * from host_reservation_view
        where user_num = #{userNum}
	</select>
	<select id="getDataByDate" resultType="int">
		select RESERVE_PRICE from host_reservation_view
		where user_num = #{userNum} and RESERVE_START_DAY = #{date}
	</select>
</mapper>